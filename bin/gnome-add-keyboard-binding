#! /usr/bin/env zsh
set -ex

PREFIX=/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings

while getopts :db:c:n: OPT; do
    case $OPT in
        d|+d)
            doDelete=1
            ;;
        b|+b)
            binding="$OPTARG"
            ;;
        c|+c)
            command="$OPTARG"
            ;;
        n|+n)
            name="$OPTARG"
            ;;
        *)
            echo "usage: ${0##*/} [+-db ARG] [+-c ARG] [+-n ARG} [--] ARGS..."
            exit 2
    esac
done
shift $(( OPTIND - 1 ))
OPTIND=1

id="$1"
[[ -n "$id" ]] && die "Must specify id"

readKey() {
    dconf read "$PREFIX/$id/$1"
}

writeKey() {
    dconf write "$PREFIX/$id/$1" "$2"
}

delete() {
    echo "DELETE $id"
}


handleVar() {
    :
}

parseArray() {
    local var="$1"
    local s="$2"
    typeset -a array
    if [[ "$s" = '@'*'[]' ]]; then
        array=()
    else
        local x=$(echo "$s" | sed 's/^\[''//;s/''\]$//')
        array=("${(@s/,/)x}")
    fi
    eval "$var=(${array[@]})"
}

formatArray() {
    typeset -a array=("$@")
    local x=${#array}
    if [[ ${#array} -eq 0 ]]; then
        echo "@as []"
    else
        local joined="${(j/', '/)array}"
        echo "['${joined}']"
    fi
}

parseArray a1 '@[]'
echo JHS ${#a1}
formatArray $a1
parseArray a2 "['abc']"
echo JHS ${a2}
echo JHS ${#a2}
formatArray $a2
parseArray a3 "['abc', 'def', 'geh']"
echo JHS ${a3}
echo JHS ${#a3}
formatArray $a3

exit 0

if [[ "$doDelete" = 1 ]]; then
    delete
else
    # Format of keyBindings is ['key1', ..., 'keyN']
    # sed removes beginning [' and ending ']
    parseArrays keyBindings $(dconf read $PREFIX)
    x=(${(s/','/)keyBindings})
    handleVar binding
    handleVar command
    handleVar name
fi
